<!DOCTYPE html>
<html lan="en">

    <head>
        <title>cv-vis</title>
        <script type="text/javascript" src="lib/webgl-utils.js"></script>
        <script type="text/javascript" src="lib/MV.js"></script>
        <script type="text/javascript" src="lib/InitShaders.js"></script>
        
        <link rel="stylesheet" type="text/css" href="assets/style/main-style.css" />

        <script type="text/javascript" src="image_tool.js"></script>


        <script id="display-vertex-shader" type="x-shader/x-vertex">
        //***************************COLOR TO B&W SHADERS:*******************************************
            attribute vec2 a_Position;
            attribute vec2 a_TexCoord; // texture coordinate of the vertex
            uniform vec2 u_Resolution;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord; // pass texture coordinates to the fragment shader
            
            void main(){

                //convert position data from pixels to range 0.0 - 1.0 (normalize)
                vec2 normalized_pos = a_Position / u_Resolution;
                // convert 0.0 - 1.0 to 0.0 - 2.0;
                vec2 doubled_pos = normalized_pos * 2.0;
                // convert to clip coords -1.0 - 1.0
                vec2 clipCoords = doubled_pos - 1.0;

                gl_Position = vec4(clipCoords, 0.0, 1.0);

                //v_Position = a_Position;
                v_TexCoord = a_TexCoord;
            }
        </script>


        
        <script id="display-fragment-shader" type="x-shader/x-fragment">
            precision highp float;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord;
             
            uniform sampler2D u_Image1;
            uniform sampler2D u_Image2;

            uniform int u_ImFlag1;
            uniform int u_ImFlag2;

            uniform float u_Dx;
            uniform float u_Dy;

            uniform float u_S; //adjusts level of detail that shows up

            vec2 uv_1;
            vec2 uv_2;

            vec4 im1Color = vec4(0.0,0.0,0.0,0.0);
            vec4 im2Color = vec4(0.0,0.0,0.0,0.0);

            void main(){

                if(u_ImFlag1 == 1){
                    gl_FragColor = texture2D(u_Image1, v_TexCoord);
                }else{
                    uv_2 = v_TexCoord - vec2(u_Dx, u_Dy);
                    if(uv_2.x >= 0.0 && uv_2.x <= 1.0 && uv_2.y >= 0.0 && uv_2.y <= 1.0){
                        im2Color = texture2D(u_Image2, uv_2);
                    }else{
                        im2Color = vec4(1.0,1.0,1.0,1.0);
                    }
                    gl_FragColor = im2Color;
                }
            } 
        </script>


        
        <script id="inten-diff-vertex-shader" type="x-shader/x-vertex">
        //***************************INTENSITY DIFF SHADERS:*******************************************
            attribute vec2 a_Position;
            attribute vec2 a_TexCoord; // texture coordinate of the vertex
            uniform vec2 u_Resolution;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord; // pass texture coordinates to the fragment shader

        
            
            void main(){

                //convert position data from pixels to range 0.0 - 1.0 (normalize)
                vec2 normalized_pos = a_Position / u_Resolution;
                // convert 0.0 - 1.0 to 0.0 - 2.0;
                vec2 doubled_pos = normalized_pos * 2.0;
                // convert to clip coords -1.0 - 1.0
                vec2 clipCoords = doubled_pos - 1.0;

                gl_Position = vec4(clipCoords, 0.0, 1.0);

                //v_Position = a_Position;
                v_TexCoord = a_TexCoord;
            }
        </script>
        
        <script id="inten-diff-fragment-shader" type="x-shader/x-fragment">
            precision highp float;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord;
             
            uniform sampler2D u_Image1;
            uniform sampler2D u_Image2;

            uniform int u_ImFlag1;
            uniform int u_ImFlag2;

            uniform float u_Dx;
            uniform float u_Dy;

            uniform float u_S; //adjusts level of detail that shows up

            vec2 uv_1;
            vec2 uv_2;

            vec4 im1Color = vec4(0.0,0.0,0.0,0.0);
            vec4 im2Color = vec4(0.0,0.0,0.0,0.0);

            void main(){
                
                //gl_FragColor = texture2D(u_Image1, v_TexCoord);

                if(u_ImFlag1 == 1){
                    im1Color = texture2D(u_Image1, v_TexCoord);
                    if(u_ImFlag2 == 0){
                        gl_FragColor = im1Color;
                    }
                }

                if(u_ImFlag2 == 1){
                    uv_2 = v_TexCoord - vec2(u_Dx, u_Dy);
                    if(uv_2.x >= 0.0 && uv_2.x <= 1.0 && uv_2.y >= 0.0 && uv_2.y <= 1.0){
                        im2Color = texture2D(u_Image2, uv_2);
                    }else{
                        im2Color = vec4(1.0,1.0,1.0,1.0);
                    }
                    
                    if(u_ImFlag1 == 0){
                        gl_FragColor = im2Color;
                    }
                }

                if(u_ImFlag1 == 1 && u_ImFlag2 == 1){
                    gl_FragColor = vec4((((im2Color).rgb - (im1Color).rgb )* u_S) + 0.5, 1.0);
                }

                if(u_ImFlag1 == 0 && u_ImFlag2 == 0){
                    gl_FragColor = vec4(0.0,0.0,0.0,1.0);
                }
                
            }
        </script>


        <script id="color-bw-vertex-shader" type="x-shader/x-vertex">
        //***************************COLOR TO B&W SHADERS:*******************************************
            attribute vec2 a_Position;
            attribute vec2 a_TexCoord; // texture coordinate of the vertex
            uniform vec2 u_Resolution;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord; // pass texture coordinates to the fragment shader
            
            void main(){

                //convert position data from pixels to range 0.0 - 1.0 (normalize)
                vec2 normalized_pos = a_Position / u_Resolution;
                // convert 0.0 - 1.0 to 0.0 - 2.0;
                vec2 doubled_pos = normalized_pos * 2.0;
                // convert to clip coords -1.0 - 1.0
                vec2 clipCoords = doubled_pos - 1.0;

                gl_Position = vec4(clipCoords, 0.0, 1.0);

                //v_Position = a_Position;
                v_TexCoord = a_TexCoord;
            }
        </script>


        
        <script id="color-bw-fragment-shader" type="x-shader/x-fragment">
            precision highp float;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord;
             
            uniform sampler2D u_Image1;
            uniform sampler2D u_Image2;

            uniform int u_ImFlag1;
            uniform int u_ImFlag2;

            uniform float u_Dx;
            uniform float u_Dy;

            uniform float u_S; //adjusts level of detail that shows up

            vec2 uv_1;
            vec2 uv_2;

            vec4 im1Color = vec4(0.0,0.0,0.0,0.0);
            vec4 im2Color = vec4(0.0,0.0,0.0,0.0);

            void main(){
                float color = 0.21 * texture2D(u_Image1, v_TexCoord).r + 
                              0.71 * texture2D(u_Image1, v_TexCoord).g + 
                              0.07 * texture2D(u_Image1, v_TexCoord).b;

                gl_FragColor = vec4(color, color, color, 1.0);
            } 
        </script>



         <script id="magnitude-vertex-shader" type="x-shader/x-vertex">
        //***********************************MAGNITUDE SHADERS:*****************************************************************
            attribute vec2 a_Position;
            attribute vec2 a_TexCoord; // texture coordinate of the vertex
            uniform vec2 u_Resolution;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord; // pass texture coordinates to the fragment shader
            
            void main(){

                //convert position data from pixels to range 0.0 - 1.0 (normalize)
                vec2 normalized_pos = a_Position / u_Resolution;
                // convert 0.0 - 1.0 to 0.0 - 2.0;
                vec2 doubled_pos = normalized_pos * 2.0;
                // convert to clip coords -1.0 - 1.0
                vec2 clipCoords = doubled_pos - 1.0;

                gl_Position = vec4(clipCoords, 0.0, 1.0);

                //v_Position = a_Position;
                v_TexCoord = a_TexCoord;
            }
        </script>


        
        <script id="magnitude-fragment-shader" type="x-shader/x-fragment">
            precision highp float;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord;
             
            uniform sampler2D u_Image1;
            uniform sampler2D u_Image2;

            uniform int u_ImFlag1;
            uniform int u_ImFlag2;

            uniform float u_Dx;
            uniform float u_Dy;

            uniform float u_S; //adjusts level of detail that shows up

            vec2 uv_1;
            vec2 uv_2;

            vec4 im1Color = vec4(0.0,0.0,0.0,0.0);
            vec4 im2Color = vec4(0.0,0.0,0.0,0.0);

            void main(){
                float color = sqrt(pow(texture2D(u_Image1, v_TexCoord).r, 2.0) + pow(texture2D(u_Image2, v_TexCoord).r, 2.0));

                gl_FragColor = vec4(color, color, color, 1.0);
            } 
        </script>


         <script id="bleyer-vertex-shader" type="x-shader/x-vertex">
        //*************************************COLOR TO B&W SHADERS:*****************************************************************
            attribute vec2 a_Position;
            attribute vec2 a_TexCoord; // texture coordinate of the vertex
            uniform vec2 u_Resolution;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord; // pass texture coordinates to the fragment shader
            
            void main(){

                //convert position data from pixels to range 0.0 - 1.0 (normalize)
                vec2 normalized_pos = a_Position / u_Resolution;
                // convert 0.0 - 1.0 to 0.0 - 2.0;
                vec2 doubled_pos = normalized_pos * 2.0;
                // convert to clip coords -1.0 - 1.0
                vec2 clipCoords = doubled_pos - 1.0;

                gl_Position = vec4(clipCoords, 0.0, 1.0);

                //v_Position = a_Position;
                v_TexCoord = a_TexCoord;
            }
        </script>


        
        <script id="bleyer-fragment-shader" type="x-shader/x-fragment">
            precision highp float;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord;
             
            uniform sampler2D u_Image1;
            uniform sampler2D u_Image2;

            uniform int u_ImFlag1;
            uniform int u_ImFlag2;

            uniform float u_Dx;
            uniform float u_Dy;

            uniform float u_S; //adjusts level of detail that shows up

            vec2 uv_1;
            vec2 uv_2;

            vec4 im1Color = vec4(0.0,0.0,0.0,0.0);
            vec4 im2Color = vec4(0.0,0.0,0.0,0.0);

            void main(){
                float color = 0.21 * texture2D(u_Image1, v_TexCoord).r + 
                              0.71 * texture2D(u_Image1, v_TexCoord).g + 
                              0.07 * texture2D(u_Image1, v_TexCoord).b;

                gl_FragColor = vec4(color, color, color, 1.0);
            } 
        </script>



        <script id="kernel-conv-vertex-shader" type="x-shader/x-vertex">
            //*********************************KERNEL CONV SHADERS:*****************************************************************
            attribute vec2 a_Position;
            attribute vec2 a_TexCoord; // texture coordinate of the vertex
            uniform vec2 u_Resolution;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord; // pass texture coordinates to the fragment shader

        
            
            void main(){

                //convert position data from pixels to range 0.0 - 1.0 (normalize)
                vec2 normalized_pos = a_Position / u_Resolution;
                // convert 0.0 - 1.0 to 0.0 - 2.0;
                vec2 doubled_pos = normalized_pos * 2.0;
                // convert to clip coords -1.0 - 1.0
                vec2 clipCoords = doubled_pos - 1.0;

                gl_Position = vec4(clipCoords, 0.0, 1.0);

                //v_Position = a_Position;
                v_TexCoord = a_TexCoord;
            }
        </script>
        
        <script id="kernel-conv-fragment-shader" type="x-shader/x-fragment">
            precision highp float;
            
            //varying vec3 v_Position;
            varying vec2 v_TexCoord;
             
            uniform sampler2D u_Image1;
            uniform sampler2D u_Image2;
            uniform sampler2D u_Kernel;
            uniform vec2 u_Anchor;
            uniform vec2 u_Resolution;

            //size & shape of the kernel
            uniform vec2 u_KRes;

            uniform int u_ImFlag1;
            uniform int u_ImFlag2;

            uniform float u_Dx;
            uniform float u_Dy;

            uniform float u_S; //adjusts level of detail that shows up

            vec2 uv_1;
            vec2 uv_2;
            

            vec4 im1Color = vec4(0.0,0.0,0.0,0.0);
            vec4 im2Color = vec4(0.0,0.0,0.0,0.0);

            void main(){
                vec2 imStep = (1.0 / u_Resolution);
                vec2 mid = floor(u_KRes / 2.0);
                vec2 step = 1.0 / u_KRes;
                vec2 initxy = step / 2.0;
                vec3 sum = vec3(0.0, 0.0, 0.0);
                vec2 center = u_Anchor;

                //if either anchor coord is (-), default that coord to the midpoint (floor) of hat dimension
                if (u_Anchor.x < 0.0){
                    center.x = mid.x;
                }
                if (u_Anchor.y < 0.0){
                    center.y = mid.y;
                }


                for (float u = 0.0; u<=155.0; u++){
                    if (u > (mid.y*2.0)) {
                            break;
                        }
                    for (float v = 0.0; v<=155.0; v++){
                        if (v > (mid.x*2.0)) {
                            break;
                        }
                        sum += (texture2D(u_Kernel, vec2(initxy.x + (v*step.x), initxy.y + (u*step.y))).r * //positive nums stored in r channel
                               texture2D(u_Image1, vec2(v_TexCoord.x + ((v-center.x)*imStep.x), v_TexCoord.y + ((u-center.y)*imStep.y)))).rgb +
                                //negative nums stored in g channnel:
                               ((-1.0)*texture2D(u_Kernel, vec2(initxy.x + (v*step.x), initxy.y + (u*step.y))).g * 
                               texture2D(u_Image1, vec2(v_TexCoord.x + ((v-center.x)*imStep.x), v_TexCoord.y + ((u-center.y)*imStep.y)))).rgb; 
                    }
                }

                gl_FragColor = vec4(sum, 1.0);  
            }
            
        </script>

    </head>
    <body>
        <div>
            <p id="dxdy_text">
                offset &gt&gt dx: <span id="dx_text"></span> dy: <span id ="dy_text"></span>
            </p>
        </div>
        <canvas id="gl-canvas" width="400" height="300">
            You need a better web browser
        </canvas>
        <p>
            <input id="im1_box" type="checkbox" name="" value="point" /> Image 1
            <input id="im2_box" type="checkbox" name="point" value="point" /> Image 2
        </p>

       <p>
            <select id="effect_menu">
                <option value="e1">Color Difference</option>
                <option value="e2">Gradient Difference</option>
            </select>
        </p>

        <pre>
        <center>
<strong>WASD</strong> or <strong>click & drag</strong> to shift image                                     <strong>shift:</strong> lock image motion to x direction only
<strong>q:</strong> slow down image motion                                               <strong>e:</strong> speed up image motion
<strong>z:</strong> decrease texture intensity                                           <strong>x:</strong> decrease texture intensity
<strong>r:</strong> reset image position                                                 <strong>shift-r:</strong> reset all controls
<strong>b:</strong> blink between images
       </center> 
        </pre>
    
    </body>
</html>